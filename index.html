<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Looper - Profesjonalny</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .app-container { width: 100%; max-width: 500px; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #444; margin-bottom: 20px; }
        
        /* Wgrywanie */
        .upload-box { border: 2px dashed #007bff; padding: 20px; text-align: center; border-radius: 10px; background: #f8fbff; cursor: pointer; margin-bottom: 20px; }
        .upload-box:hover { background: #eef5ff; }
        #fileInput { display: none; }

        /* Odtwarzacz */
        .player-section { background: #333; color: white; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 25px; }
        .now-playing { font-size: 14px; margin-bottom: 10px; color: #00d1ff; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        audio { width: 100%; height: 35px; }

        /* Lista utworów */
        .playlist-header { font-weight: bold; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .track-list { display: flex; flex-direction: column; gap: 8px; }
        .track-item { display: flex; justify-content: space-between; align-items: center; background: #fff; border: 1px solid #ddd; padding: 10px; border-radius: 8px; transition: 0.2s; }
        .track-item.active { border-color: #007bff; background: #f0f7ff; box-shadow: 0 2px 5px rgba(0,123,255,0.2); }
        
        .track-name { cursor: pointer; flex-grow: 1; font-size: 14px; color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-right: 10px; }
        .track-name:hover { color: #007bff; }

        .btn-delete { background: #ff4d4d; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 12px; transition: 0.2s; }
        .btn-delete:hover { background: #cc0000; }

        .empty-info { text-align: center; color: #999; font-size: 14px; margin-top: 20px; }
        .footer { font-size: 11px; color: #aaa; text-align: center; margin-top: 30px; }
    </style>
</head>
<body>

<div class="app-container">
    <h1>Audio Looper</h1>

    <!-- 1. Pole wyboru plików -->
    <div class="upload-box" onclick="document.getElementById('fileInput').click()">
        <strong>+ Dodaj pliki MP3 / WAV</strong>
        <p style="font-size: 12px; margin: 5px 0 0;">Możesz zaznaczyć wiele plików naraz</p>
        <input type="file" id="fileInput" accept="audio/mp3, audio/wav, audio/mpeg" multiple>
    </div>

    <!-- 2. Sekcja odtwarzacza (zawsze na górze) -->
    <div class="player-section">
        <div id="statusLabel" class="now-playing">Wgraj muzykę, aby zacząć</div>
        <audio id="audioPlayer" controls></audio>
    </div>

    <!-- 3. Lista utworów (zawsze widoczna) -->
    <div class="playlist-header">
        Twoja lista:
        <span id="trackCount" style="font-weight: normal; font-size: 12px; color: #666;">0 utworów</span>
    </div>
    <div id="playlistContainer" class="track-list">
        <!-- Tutaj skrypt wstawi utwory -->
    </div>
    <div id="emptyMessage" class="empty-info">Twoja lista jest pusta</div>

    <div class="footer">Wszystko działa lokalnie. Pliki nie znikają po odświeżeniu strony.</div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const audioPlayer = document.getElementById('audioPlayer');
    const playlistContainer = document.getElementById('playlistContainer');
    const statusLabel = document.getElementById('statusLabel');
    const emptyMessage = document.getElementById('emptyMessage');
    const trackCount = document.getElementById('trackCount');

    let db;
    let playlist = []; // Aktualna lista utworów w pamięci
    let currentIndex = 0;

    // --- BAZA DANYCH (ZAPAMIĘTYWANIE PLIKÓW) ---
    const request = indexedDB.open("LooperDatabase", 1);
    
    request.onupgradeneeded = e => {
        db = e.target.result;
        db.createObjectStore("songs", { keyPath: "id", autoIncrement: true });
    };

    request.onsuccess = e => {
        db = e.target.result;
        loadPlaylist(); // Ładuj pliki przy starcie
    };

    // --- ŁADOWANIE I WYŚWIETLANIE LISTY ---
    function loadPlaylist() {
        const transaction = db.transaction("songs", "readonly");
        const store = transaction.objectStore("songs");
        const requestAll = store.getAll();

        requestAll.onsuccess = () => {
            playlist = requestAll.result;
            renderUI();
        };
    }

    function renderUI() {
        playlistContainer.innerHTML = "";
        trackCount.innerText = `${playlist.length} utworów`;
        
        if (playlist.length === 0) {
            emptyMessage.style.display = "block";
            statusLabel.innerText = "Wgraj muzykę, aby zacząć";
            audioPlayer.src = "";
            return;
        }

        emptyMessage.style.display = "none";

        playlist.forEach((song, index) => {
            const item = document.createElement('div');
            item.className = 'track-item' + (index === currentIndex && audioPlayer.src !== "" ? " active" : "");
            
            item.innerHTML = `
                <div class="track-name" title="Kliknij, aby odtworzyć">${index + 1}. ${song.name}</div>
                <button class="btn-delete">Usuń</button>
            `;

            // Odtwarzanie po kliknięciu w nazwę
            item.querySelector('.track-name').onclick = () => playTrack(index);

            // Usuwanie po kliknięciu w przycisk
            item.querySelector('.btn-delete').onclick = () => deleteTrack(song.id);

            playlistContainer.appendChild(item);
        });
    }

    // --- OBSŁUGA PLIKÓW ---
    fileInput.onchange = e => {
        const files = Array.from(e.target.files);
        const transaction = db.transaction("songs", "readwrite");
        const store = transaction.objectStore("songs");

        files.forEach(file => {
            if (file.type.includes("audio")) {
                store.add({ name: file.name, data: file });
            }
        });

        transaction.oncomplete = () => {
            loadPlaylist();
            fileInput.value = ""; // Resetuj input
        };
    };

    function deleteTrack(id) {
