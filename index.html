<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profesjonalny Audio Looper</title>
    <style>
        :root {
            --bg: #121212;
            --card: #1e1e1e;
            --accent: #bb86fc;
            --text: #e0e0e0;
            --danger: #cf6679;
            --active: #3700b3;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        .app-container {
            width: 100%;
            max-width: 500px;
            background: var(--card);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        h1 { font-size: 24px; text-align: center; color: var(--accent); margin-top: 0; }
        p { font-size: 14px; text-align: center; opacity: 0.7; }

        /* Obszar wgrywania */
        .drop-zone {
            border: 2px dashed #444;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
            margin-bottom: 20px;
        }
        .drop-zone:hover { border-color: var(--accent); background: rgba(187, 134, 252, 0.05); }
        #fileInput { display: none; }

        /* Odtwarzacz */
        .player-box {
            background: #252525;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }
        audio { width: 100%; filter: invert(100%); margin-top: 10px; }
        .now-playing { font-size: 13px; font-weight: bold; color: var(--accent); margin-bottom: 5px; height: 1.2em; overflow: hidden; }

        /* Lista utworów */
        .playlist { list-style: none; padding: 0; margin: 0; }
        .track-item {
            display: flex;
            align-items: center;
            background: #2c2c2c;
            margin-bottom: 8px;
            padding: 10px 15px;
            border-radius: 8px;
            gap: 10px;
            transition: 0.2s;
        }
        .track-item.active { background: var(--active); border-left: 4px solid var(--accent); }
        
        .track-info { flex-grow: 1; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
        
        .btn-delete {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 18px;
            padding: 5px;
            line-height: 1;
        }
        .btn-delete:hover { transform: scale(1.2); }

        .empty-state { text-align: center; opacity: 0.4; font-style: italic; margin-top: 20px; }

        .footer { font-size: 11px; text-align: center; margin-top: 20px; opacity: 0.5; }
    </style>
</head>
<body>

<div class="app-container">
    <h1>Audio Looper</h1>
    <p>Wgraj MP3/WAV. Pliki pozostaną na liście do momentu ich usunięcia.</p>

    <div class="drop-zone" onclick="document.getElementById('fileInput').click()">
        <strong>+ Dodaj pliki audio</strong>
        <br><span style="font-size: 12px;">MP3 lub WAV</span>
        <input type="file" id="fileInput" accept="audio/*" multiple>
    </div>

    <div class="player-box">
        <div class="now-playing" id="trackName">Czekam na pliki...</div>
        <audio id="mainPlayer" controls></audio>
    </div>

    <ul id="playlistUI" class="playlist"></ul>
    <div id="emptyMsg" class="empty-state">Brak utworów na liście</div>

    <div class="footer">Wszystkie pliki przechowywane są tylko lokalnie w Twojej przeglądarce.</div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const player = document.getElementById('mainPlayer');
    const playlistUI = document.getElementById('playlistUI');
    const trackNameDisplay = document.getElementById('trackName');
    const emptyMsg = document.getElementById('emptyMsg');

    let playlist = []; // {id, name, blob}
    let currentIndex = -1;
    let db;

    // 1. INICJALIZACJA BAZY DANYCH (IndexedDB)
    const request = indexedDB.open("LooperStore", 1);
    request.onupgradeneeded = e => {
        db = e.target.result;
        db.createObjectStore("songs", { keyPath: "id", autoIncrement: true });
    };
    request.onsuccess = e => {
        db = e.target.result;
        loadSongs();
    };

    // 2. ŁADOWANIE ZAPISANYCH UTWORÓW
    function loadSongs() {
        const transaction = db.transaction("songs", "readonly");
        const store = transaction.objectStore("songs");
        const getRequest = store.getAll();

        getRequest.onsuccess = () => {
            playlist = getRequest.result;
            refreshUI();
            if (playlist.length > 0 && currentIndex === -1) {
                setTrack(0, false);
            }
        };
    }

    // 3. DODAWANIE PLIKÓW
    fileInput.onchange = e => {
        const files = Array.from(e.target.files);
        const transaction = db.transaction("songs", "readwrite");
        const store = transaction.objectStore("songs");

        files.forEach(file => {
            if (file.type.startsWith('audio/')) {
                const song = { name: file.name, data: file };
                const addReq = store.add(song);
                addReq.onsuccess = (ev) => {
                    song.id = ev.target.result;
                    playlist.push(song);
                    refreshUI();
                    if (currentIndex === -1) setTrack(0, false);
                };
            }
        });
    };

    // 4. ODŚWIEŻANIE WIDOKU LISTY
    function refreshUI() {
        playlistUI.innerHTML = "";
        emptyMsg.style.display = playlist.length ? "none" : "block";

        playlist.forEach((song, index) => {
            const li = document.createElement('li');
            li.className = `track-item ${index === currentIndex ? 'active' : ''}`;
            li.innerHTML = `
                <div class="track-info">${index + 1}. ${song.name}</div>
                <button class="btn-delete" title="Usuń">×</button>
            `;

            li.querySelector('.track-info').onclick = () => setTrack(index, true);
            li.querySelector('.btn-delete').onclick = (e) => {
                e.stopPropagation();
                deleteSong(song.id, index);
            };

            playlistUI.appendChild(li);
        });
    }

    // 5. USTAWIANIE UTWORU
    function setTrack(index, autoPlay) {
        if (index < 0 || index >= playlist.length) return;
        
        currentIndex = index;
        const song = playlist[currentIndex];
        const url = URL.createObjectURL(song.data);
        
        player.src = url;
        trackNameDisplay.textContent = song.name;
        
        refreshUI();
        if (autoPlay) player.play();
    }

    // 6. USUWANIE UTWORU
    function deleteSong(id, index) {
        const transaction = db.transaction("songs", "readwrite");
        const store = transaction.objectStore("songs");
        store.delete(id).onsuccess = () => {
            playlist.splice(index, 1);
            
            if (currentIndex === index) {
                player.pause();
                player.src = "";
                trackNameDisplay.textContent = "Wybierz utwór";
                currentIndex = -1;
                if (playlist.length > 0) setTrack(0, false);
            } else if (currentIndex > index) {
                currentIndex--;
            }
            
            refreshUI();
        };
    }

    // 7. LOGIKA PĘTLI
    player.onended = () => {
        let nextIndex = currentIndex + 1;
        if (nextIndex >= playlist.length) nextIndex = 0; // Wróć do początku
        setTrack(nextIndex, true);
    };

</script>

</body>
</html>
