<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Odtwarzacz z Pętlą</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            display: flex;
            justify-content: center;
            padding: 20px;
            margin: 0;
        }
        .main-container {
            width: 100%;
            max-width: 600px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        h1 { text-align: center; color: #333; }
        
        /* Sekcja wgrywania */
        .upload-section {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 8px;
            background: #fafafa;
        }
        #fileInput { margin-top: 10px; }

        /* Odtwarzacz */
        .player-wrapper {
            background: #eee;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        audio { width: 100%; }
        .now-playing { font-weight: bold; margin-bottom: 10px; color: #555; }

        /* LISTA UTWORÓW */
        .playlist-title { font-weight: bold; margin-bottom: 10px; border-bottom: 2px solid #ddd; padding-bottom: 5px; }
        #playlistDisplay { list-style: none; padding: 0; margin: 0; }
        
        .track-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #fff;
            border: 1px solid #ddd;
            margin-bottom: 5px;
            border-radius: 5px;
        }
        .track-item.active { background-color: #e3f2fd; border-color: #2196f3; }
        
        .track-name { 
            cursor: pointer; 
            flex-grow: 1; 
            margin-right: 10px;
            color: #333;
        }
        .track-name:hover { color: #2196f3; text-decoration: underline; }

        .delete-btn {
            background-color: #ff5252;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .delete-btn:hover { background-color: #d32f2f; }
        
        .footer-info { font-size: 12px; color: #888; text-align: center; margin-top: 20px; }
    </style>
</head>
<body>

<div class="main-container">
    <h1>Audio Looper</h1>
    
    <div class="upload-section">
        <strong>Wybierz pliki MP3 lub WAV:</strong><br>
        <input type="file" id="fileInput" accept="audio/*" multiple>
    </div>

    <div class="player-wrapper">
        <div class="now-playing" id="currentTitle">Brak utworów</div>
        <audio id="audioElement" controls></audio>
    </div>

    <div class="playlist-title">Twoja lista utworów:</div>
    <div id="playlistDisplay">
        <!-- Tu pojawią się utwory -->
    </div>

    <div class="footer-info">Pliki są zapisywane w pamięci przeglądarki. Nie znikną po odświeżeniu.</div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const audio = document.getElementById('audioElement');
    const playlistDisplay = document.getElementById('playlistDisplay');
    const currentTitle = document.getElementById('currentTitle');

    let db;
    let tracks = []; // lokalna lista utworów
    let currentIndex = 0;

    // 1. Otwieranie bazy danych IndexedDB (pamięć trwała)
    const request = indexedDB.open("MusicLooperDB", 1);
    
    request.onupgradeneeded = (e) => {
        db = e.target.result;
        db.createObjectStore("songs", { keyPath: "id", autoIncrement: true });
    };

    request.onsuccess = (e) => {
        db = e.target.result;
        refreshPlaylist(); // ładuj pliki po starcie
    };

    // 2. Obsługa dodawania plików
    fileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        
        files.forEach(file => {
            const transaction = db.transaction("songs", "readwrite");
            const store = transaction.objectStore("songs");
            const songData = { name: file.name, blob: file };
            
            store.add(songData).onsuccess = () => {
                refreshPlaylist();
            };
        });
    });

    // 3. Wyświetlanie listy utworów i przycisków USUŃ
    function refreshPlaylist() {
        const transaction = db.transaction("songs", "readonly");
        const store = transaction.objectStore("songs");
        const getAll = store.getAll();

        getAll.onsuccess = () => {
            tracks = getAll.result;
            playlistDisplay.innerHTML = "";

            if (tracks.length === 0) {
                playlistDisplay.innerHTML = "<p style='color: #999; text-align: center;'>Lista jest pusta</p>";
                currentTitle.innerText = "Brak utworów";
                audio.src = "";
                return;
            }

            tracks.forEach((track, index) => {
                const div = document.createElement('div');
                div.className = "track-item" + (index === currentIndex && audio.src !== "" ? " active" : "");
                
                div.innerHTML = `
                    <span class="track-name">${index + 1}. ${track.name}</span>
                    <button class="delete-btn">Usuń</button>
                `;

                // Kliknięcie w nazwę -> odtwarzaj
                div.querySelector('.track-name').onclick = () => playTrack(index);

                // Kliknięcie w USUŃ
                div.querySelector('.delete-btn').onclick = () => deleteTrack(track.id);

                playlistDisplay.appendChild(div);
            });
        };
    }

    // 4. Odtwarzanie konkretnego utworu
    function playTrack(index) {
        if (index < 0 || index >= tracks.length) return;
        
        currentIndex = index;
        const track = tracks[currentIndex];
        
        // Tworzymy tymczasowy link do pliku w pamięci
        const url = URL.createObjectURL(track.blob);
        audio.src = url;
        currentTitle.innerText = "Gra teraz: " + track.name;
        
        audio.play();
        refreshPlaylist();
    }

    // 5. Usuwanie utworu
    function deleteTrack(id) {
        const transaction = db.transaction("songs", "readwrite");
        const store = transaction.objectStore("songs");
        
        store.delete(id).onsuccess = () => {
            // Jeśli usuwamy ostatni utwór lub ten który gra, zatrzymaj muzykę
            if (tracks.length === 1) {
                audio.pause();
                audio.src = "";
            }
            refreshPlaylist();
        };
    }

    // 6. Logika PĘTLI (następny po zakończeniu)
    audio.onended = () => {
        let nextIndex = currentIndex + 1;
        if (nextIndex >= tracks.length) {
            nextIndex = 0; // Wróć do początku jeśli koniec listy
        }
        playTrack(nextIndex);
    };

</script>

</body>
</html>
